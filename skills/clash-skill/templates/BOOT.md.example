---
# OpenClaw 集成模板文件

## 本文件说明

这是 OpenClaw Gateway 启动时的 Hook 模板文件。

将本文件的内容复制到 `/home/node/.openclaw/workspace/BOOT.md`，
OpenClaw Gateway 每次启动时都会自动执行其中的命令。

---

# BOOT.md - OpenClaw Gateway 启动时自动执行 Clash

## 功能

OpenClaw Gateway 启动后，自动启动 Clash 代理服务。

## 使用方法

1. 复制本文件的内容到 `/home/node/.openclaw/workspace/BOOT.md`
2. 确保 Clash 已经通过 `scripts/install.sh` 安装
3. 重启 OpenClaw Gateway 测试

## 重启 OpenClaw Gateway

```bash
# 方法 1: 通过 CLI
openclaw gateway restart

# 方法 2: 通过 systemd
sudo systemctl restart openclaw-gateway

# 方法 3: 直接重启进程
pkill -f openclaw-gateway
# 然后手动启动
openclaw gateway start
```

---

### 启动 Clash 代理

**重要说明**: OpenClaw 工作目录可能因安装位置而异。请根据实际情况选择以下任一方式：

#### 方式 1: 使用相对路径（推荐 - 从 workspace 根目录执行）

当 Boot hook 在 OpenClaw workspace 根目录执行时，clash-skill 应该在根目录下的子目录：

```bash
echo "[$(date '+%Y-%m-%d %H:%M:%S')] [BOOT] 启动 Clash 代理..." >> /tmp/openclaw-boot.log

# 启动 Clash（相对路径）
bash clash-skill/scripts/clash.sh start

# 检查启动结果
if [ $? -eq 0 ]; then
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] [BOOT] Clash 启动成功" >> /tmp/openclaw-boot.log
else
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] [BOOT] Clash 启动失败" >> /tmp/openclaw-boot.log
fi
```

#### 方式 2: 绝对路径（明确指定完整路径）

如果 clash-skill 在其他位置，使用绝对路径：

```bash
echo "[$(date '+%Y-%m-%d %H:%M:%S')] [BOOT] 启动 Clash 代理..." >> /tmp/openclaw-boot.log

# 常见 OpenClaw 安装位置：
# - WSL2: /home/username/.openclaw/workspace/clash-skill
# - Linux: /home/username/.openclaw/workspace/clash-skill
# - 自定义: /path/to/your/workspace/clash-skill

# 替换下面的路径为实际的 clash-skill 目录
CLASH_SKILL_DIR="${OPENCLAW_WORKSPACE:-$HOME/.openclaw/workspace}/clash-skill"
bash "$CLASH_SKILL_DIR/scripts/clash.sh" start

# 检查启动结果
if [ $? -eq 0 ]; then
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] [BOOT] Clash 启动成功" >> /tmp/openclaw-boot.log
else
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] [BOOT] Clash 启动失败" >> /tmp/openclaw-boot.log
fi
```

#### 方式 3: 自动检测路径（兼容性最好）

自动检测 workspace 和 clash-skill 目录：

```bash
echo "[$(date '+%Y-%m-%d %H:%M:%S')] [BOOT] 启动 Clash 代理..." >> /tmp/openclaw-boot.log

# 自动检测 clash-skill 目录
if [ -f "clash-skill/scripts/clash.sh" ]; then
    # 情况1: clash-skill 在当前目录（相对路径）
    bash clash-skill/scripts/clash.sh start
elif [ -f "$HOME/.openclaw/workspace/clash-skill/scripts/clash.sh" ]; then
    # 情况2: 默认位置
    bash "$HOME/.openclaw/workspace/clash-skill/scripts/clash.sh" start
elif [ -f "/opt/openclaw/workspace/clash-skill/scripts/clash.sh" ]; then
    # 情况3: 系统安装位置
    bash "/opt/openclaw/workspace/clash-skill/scripts/clash.sh" start
else
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] [BOOT] 错误: 找不到 clash-skill 目录" >> /tmp/openclaw-boot.log
    exit 1
fi

# 检查启动结果
if [ $? -eq 0 ]; then
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] [BOOT] Clash 启动成功" >> /tmp/openclaw-boot.log
else
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] [BOOT] Clash 启动失败" >> /tmp/openclaw-boot.log
fi
```

### 可选：启用代理环境变量（不建议）

**注意**: 一般不建议在 BOOT.md 中设置代理环境变量，
因为这会影响所有网络请求。建议通过脚本手动切换。

如果确实需要全局代理，可以取消注释以下内容：

```bash
# # 启用代理环境变量（谨慎使用）
# # 注意：需要根据实际位置调整 clash-skill 路径
# if [ -f "clash-skill/scripts/proxy.sh" ]; then
#     source clash-skill/scripts/proxy.sh
# elif [ -f "$HOME/.openclaw/workspace/clash-skill/scripts/proxy.sh" ]; then
#     source "$HOME/.openclaw/workspace/clash-skill/scripts/proxy.sh"
# fi
```

---

## 验证 Gateway 启动时 Clash 是否启动

### 查看启动日志

```bash
# 查看 OpenClaw 启动日志
tail -f /tmp/openclaw-boot.log

# 查看 Clash 启动日志
tail -f /tmp/clash.log

# 查看 Clash 监控日志
tail -f /tmp/clash-monitor.log
```

### 检查进程

```bash
# 检查 Clash 是否在运行
pgrep -x clash

# 查看进程详细信息
ps aux | grep clash
```

### 测试代理

```bash
# 启用代理（自动检测路径）
if [ -f "clash-skill/scripts/proxy.sh" ]; then
    source clash-skill/scripts/proxy.sh
elif [ -f "$HOME/.openclaw/workspace/clash-skill/scripts/proxy.sh" ]; then
    source "$HOME/.openclaw/workspace/clash-skill/scripts/proxy.sh"
fi

# 测试连接
curl -I https://www.google.com
```

---

## 高级：自定义启动逻辑

### 条件启动

只在特定条件下启动 Clash：

```bash
# 检查是否已安装 Clash
if [ -f "$HOME/bin/clash" ]; then
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] [BOOT] Clash 已安装，正在启动..."

    # 自动检测并启动
    if [ -f "clash-skill/scripts/clash.sh" ]; then
        bash clash-skill/scripts/clash.sh start
    elif [ -f "$HOME/.openclaw/workspace/clash-skill/scripts/clash.sh" ]; then
        bash "$HOME/.openclaw/workspace/clash-skill/scripts/clash.sh" start
    else
        echo "[$(date '+%Y-%m-%d %H:%M:%S')] [BOOT] 错误: 找不到 clash-skill 脚本" >> /tmp/openclaw-boot.log
        exit 1
    fi
else
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] [BOOT] Clash 未安装，跳过..."
fi
```

### 延迟启动

如果需要在其他服务启动后再启动 Clash：

```bash
# 等待 5 秒后启动
echo "[$(date '+%Y-%m-%d %H:%M:%S')] [BOOT] 等待 5 秒..."
sleep 5

echo "[$(date '+%Y-%m-%d %H:%M:%S')] [BOOT] 启动 Clash..."

# 自动检测并启动
if [ -f "clash-skill/scripts/clash.sh" ]; then
    bash clash-skill/scripts/clash.sh start
elif [ -f "$HOME/.openclaw/workspace/clash-skill/scripts/clash.sh" ]; then
    bash "$HOME/.openclaw/workspace/clash-skill/scripts/clash.sh" start
fi
```

### 重试机制

如果启动失败，自动重试：

```bash
MAX_RETRIES=3
RETRY_COUNT=0

# 自动检测 clash-skill 脚本路径
CLASH_SCRIPT=""
if [ -f "clash-skill/scripts/clash.sh" ]; then
    CLASH_SCRIPT="clash-skill/scripts/clash.sh"
elif [ -f "$HOME/.openclaw/workspace/clash-skill/scripts/clash.sh" ]; then
    CLASH_SCRIPT="$HOME/.openclaw/workspace/clash-skill/scripts/clash.sh"
fi

if [ -z "$CLASH_SCRIPT" ]; then
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] [BOOT] 错误: 找不到 clash-skill 脚本" >> /tmp/openclaw-boot.log
    exit 1
fi

while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] [BOOT] 尝试启动 Clash (第 $((RETRY_COUNT+1)) 次)..."

    bash "$CLASH_SCRIPT" start

    if [ $? -eq 0 ]; then
        echo "[$(date '+%Y-%m-%d %H:%M:%S')] [BOOT] Clash 启动成功"
        break
    else
        echo "[$(date '+%Y-%m-%d %H:%M:%S')] [BOOT] Clash 启动失败，等待 3 秒后重试..."
        RETRY_COUNT=$((RETRY_COUNT + 1))
        sleep 3
    fi
done

if [ $RETRY_COUNT -eq $MAX_RETRIES ]; then
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] [BOOT] Clash 启动失败，已达到最大重试次数"
fi
```

---

## 故障排查

### 问题：Gateway 重启后 Clash 未启动

**检查清单：**

1. BOOT.md 文件是否存在
   ```bash
   # 检查默认位置
   ls -lh ~/.openclaw/workspace/BOOT.md

   # 或检查自定义位置（根据实际情况）
   ls -lh /path/to/your/workspace/BOOT.md
   ```

2. BOOT.md 内容是否正确
   ```bash
   cat ~/.openclaw/workspace/BOOT.md
   # 或
   cat /path/to/your/workspace/BOOT.md
   ```

3. Clash 是否已安装
   ```bash
   which clash
   # 或
   ls -lh ~/bin/clash
   ```

4. Clash 脚本路径是否正确
   ```bash
   # 检查相对路径（从 workspace 根目录）
   ls -lh clash-skill/scripts/clash.sh

   # 检查默认位置
   ls -lh ~/.openclaw/workspace/clash-skill/scripts/clash.sh

   # 检查自定义位置
   ls -lh /path/to/clash-skill/scripts/clash.sh
   ```

5. 查看启动日志
   ```bash
   tail -20 /tmp/openclaw-boot.log
   ```

6. 检查 boot-md hook 是否启用
   ```bash
   openclaw hooks list
   # 或直接检查配置文件
   cat ~/.openclaw/openclaw.json | grep -A 5 "boot-md"
   ```

---

## 相关文档

- **[安装指南](../docs/SETUP.md)** - 完整安装步骤
- **[使用指南](../docs/USAGE.md)** - 日常使用方法
- **[故障排查](../docs/TROUBLESHOOTING.md)** - 常见问题解决

---

**最后更新**: 2026-02-27
**模板版本**: 1.0
